# mini_dbm
mini_dbm 是一个简单的录像存储系统： \
我们原本打算使用ETCD做一个分布式的监控存储系统，进而发现ETCD的后端基于B+ Tree，对于这种系统并不合适，而简单使用数组做索引就可以了。\
严格来说，mini_dbm既算不上传统意义上的关系型数据库，也很难谈得上是nosql的一种。\
考虑我们主要的需求：将一个由Raft发来的KV写入磁盘，这个KV是由一个时间戳与二进制的录像内容组成。对于B+ Tree来说，在写满磁盘上的一页后，将发生分裂，而我们的时间戳总是单调递增的，那么分裂后前面一页总是半满的，也就造成了磁盘空间的浪费；而维护一个LSM Tree也同样面临写放大，读放大等问题。实际上，正是这些系统不能对输入做任何保证，导致了它们在顺序写入时需要负担额外的复杂度。此外，我们也不需要支持关系模型，不需要支持结构化数据，也不必支持事务(但是在这个系统上提供事务的强隔离级别是相对容易的)。\
比较贴近我们需求的是一种名为DBM的系统，GDBM是GNU的DBM实现。遗憾的是，GDBM是基于Hash的索引，考虑我们的另一个需求：首先插入一个<0,content1>的KV,这是0秒到10秒的录像，再插入一个<10,content2>的KV，这时如果需要查看读第6秒的录像
那就需要我们返回第一个KV，而Hash是不能提供区间查找的。\
较为朴素的实现是总在磁盘顺序写入，同时在内存中维护一个数组，在需要查询时，对数组进行二分查找。另外，我们还尝试其他了优化方法，比如一阶逼近，或者多项式拟合，部分实现在src/index里。\
我们为这个系统实现了简单的缓存池，由于读与写大部分时候并不会发生在同一个页上，这个缓存池的实现也相对简单。另一方面，考虑到数组本身也需要写入磁盘，我们实现了一个可二分搜索，可以写入磁盘的数组，而这个数组的内存申请大部分时候都是申请一个PAGE_SIZE大小的块，我们将为其实现了一个专用的alloc函数供其调用。




